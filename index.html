<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Redirecting to Email</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 2em;
        line-height: 1.6;
      }
      code {
        background-color: #f4f4f4;
        padding: 2px 6px;
        border-radius: 4px;
      }
      a {
        color: #007bff;
      }
    </style>
  </head>
  <body>
    <h1>Preparing your email...</h1>
    <p>If you are not redirected automatically, <a id="mailto-link" href="#">click here to open your email client</a>.</p>

    <div id="no-handler-message" style="display: none">
      <h2>Could not open your email client</h2>
      <p>
        It seems you may not have a default email client configured on your device. You can manually compose the email using the
        details below:
      </p>
      <div style="margin-top: 1.5em">
        <strong>To:</strong> <code id="manual-to"></code><br />
        <span id="manual-cc-container" style="display: none"><strong>Cc:</strong> <code id="manual-cc"></code><br /></span>
        <span id="manual-bcc-container" style="display: none"><strong>Bcc:</strong> <code id="manual-bcc"></code><br /></span>
        <strong>Subject:</strong> <code id="manual-subject"></code><br />
        <strong>Body:</strong>
        <pre><code id="manual-body"></code></pre>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        try {
          const urlParams = new URLSearchParams(window.location.search);

          let mailtoLink = "mailto:";

          const mailtoParams = new URLSearchParams();
          const to = urlParams.get("to");
          const subject = urlParams.get("subject");
          const body = urlParams.get("body");
          const cc = urlParams.get("cc");
          const bcc = urlParams.get("bcc");

          if (to) mailtoParams.set("to", to);
          if (subject) mailtoParams.set("subject", subject);
          if (body) mailtoParams.set("body", body);
          if (cc) {
            mailtoParams.set("cc", cc);
            document.getElementById("manual-cc").textContent = cc;
            document.getElementById("manual-cc-container").style.display = "inline";
          }
          if (bcc) {
            mailtoParams.set("bcc", bcc);
            document.getElementById("manual-bcc").textContent = bcc;
            document.getElementById("manual-bcc-container").style.display = "inline";
          }

          document.getElementById("manual-to").textContent = to || "";
          document.getElementById("manual-subject").textContent = subject || "";
          document.getElementById("manual-body").textContent = body || "";

          const mailtoParamsString = mailtoParams.toString();
          if (mailtoParamsString) {
            mailtoLink += `?${mailtoParamsString}`;
          }

          const mailtoLinkElement = document.getElementById("mailto-link");
          if (mailtoLinkElement) {
            mailtoLinkElement.href = mailtoLink;
          }

          const headingElement = document.querySelector("h1");
          if (headingElement) {
            headingElement.textContent = "Redirecting you to your email client...";
          }

          // Redirect
          if (localStorage.getItem("debug-no-redirect") !== "true") {
            window.location.href = mailtoLink;
          }

          setTimeout(function () {
            if (document.visibilityState === "visible") {
              // If the page is still visible after a delay, it's likely no mail handler was found.
              document.querySelector("h1").style.display = "none";
              document.querySelector("p").style.display = "none";
              document.getElementById("no-handler-message").style.display = "block";
            }
          }, 2000);
        } catch (e) {
          document.body.innerHTML = "<h1>Error</h1><p>An unexpected error occurred while generating the email link.</p>";
          console.error(e);
        }
      });
    </script>
  </body>
</html>
