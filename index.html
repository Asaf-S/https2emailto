<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
    <script>
      const strings = {
        en: {
          documentTitle: "Redirecting to Email...",
          mainHeading: "Preparing your email...",
          redirectMessage:
            'If you are not redirected automatically, <a id="mailto-link" href="#">click here to open your email client</a>.',
          noHandlerHeading: "Could not open your email client",
          noHandlerMessage:
            "It seems you may not have a default email client configured on your device. You can manually compose the email using the details below:",
          toLabel: "To:",
          ccLabel: "Cc:",
          bccLabel: "Bcc:",
          subjectLabel: "Subject:",
          bodyLabel: "Body:",
          errorHeading: "Error",
          errorMessage: "An unexpected error occurred while generating the email link.",
        },
        he: {
          // spell-checker: disable
          documentTitle: "מפנה למייל...",
          mainHeading: "מכין את המייל שלך...",
          redirectMessage: 'אם ההפניה האוטומטית לא עובדת, <a id="mailto-link-he" href="#">לחץ כאן לפתיחת תוכנת המייל</a>.',
          noHandlerHeading: "לא ניתן לפתוח את תוכנת המייל",
          noHandlerMessage: "נראה שאין לך תוכנת מייל מוגדרת במכשיר. תוכל לכתוב את המייל באופן ידני עם הפרטים הבאים:",
          toLabel: "אל:",
          ccLabel: "עותק:",
          bccLabel: "עותק נסתר:",
          subjectLabel: "נושא:",
          bodyLabel: "גוף ההודעה:",
          errorHeading: "שגיאה",
          errorMessage: "אירעה שגיאה בלתי צפויה בעת יצירת קישור המייל.",
          // spell-checker: enable
        },
      };
    </script>
    <style>
      body {
        font-family: sans-serif;
        padding: 2em;
        line-height: 1.6;
      }
      code {
        background-color: #f4f4f4;
        padding: 2px 6px;
        border-radius: 4px;
      }
      a {
        color: #007bff;
      }
    </style>
  </head>
  <body>
    <h1></h1>
    <p></p>

    <div id="no-handler-message" style="display: none">
      <h2></h2>
      <p></p>
      <div style="margin-top: 1.5em">
        <strong data-key="toLabel"></strong> <code id="manual-to"></code><br />
        <span id="manual-cc-container" style="display: none"
          ><strong data-key="ccLabel"></strong> <code id="manual-cc"></code><br
        /></span>
        <span id="manual-bcc-container" style="display: none"
          ><strong data-key="bccLabel"></strong> <code id="manual-bcc"></code><br
        /></span>
        <strong data-key="subjectLabel"></strong> <code id="manual-subject"></code><br />
        <strong data-key="bodyLabel"></strong>
        <pre><code id="manual-body"></code></pre>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const lang = navigator.language.split("-")[0] === "he" || localStorage.getItem("debug-lang") === "he" ? "he" : "en";
        const s = strings[lang];

        if (lang === "he") {
          document.documentElement.lang = "he";
          document.documentElement.dir = "rtl";
        }

        document.title = s.documentTitle;
        document.querySelector("h1").textContent = s.mainHeading;
        document.querySelector("p").innerHTML = s.redirectMessage;
        document.querySelector("h2").textContent = s.noHandlerHeading;
        document.querySelector("#no-handler-message p").textContent = s.noHandlerMessage;

        document.querySelector('[data-key="toLabel"]').textContent = s.toLabel;
        document.querySelector('[data-key="ccLabel"]').textContent = s.ccLabel;
        document.querySelector('[data-key="bccLabel"]').textContent = s.bccLabel;
        document.querySelector('[data-key="subjectLabel"]').textContent = s.subjectLabel;
        document.querySelector('[data-key="bodyLabel"]').textContent = s.bodyLabel;

        try {
          const urlParams = new URLSearchParams(window.location.search);

          let mailtoLink = "mailto:";

          const mailtoParams = new URLSearchParams();
          const to = urlParams.get("to");
          const subject = urlParams.get("subject");
          const body = urlParams.get("body");
          const cc = urlParams.get("cc");
          const bcc = urlParams.get("bcc");

          if (to) mailtoParams.set("to", to);
          if (subject) mailtoParams.set("subject", subject);
          if (body) mailtoParams.set("body", body);
          if (cc) {
            mailtoParams.set("cc", cc);
            document.getElementById("manual-cc").textContent = cc;
            document.getElementById("manual-cc-container").style.display = "inline";
          }
          if (bcc) {
            mailtoParams.set("bcc", bcc);
            document.getElementById("manual-bcc").textContent = bcc;
            document.getElementById("manual-bcc-container").style.display = "inline";
          }

          document.getElementById("manual-to").textContent = to || "";
          document.getElementById("manual-subject").textContent = subject || "";
          document.getElementById("manual-body").textContent = body || "";

          const mailtoParamsString = mailtoParams.toString();
          if (mailtoParamsString) {
            mailtoLink += `?${mailtoParamsString}`;
          }

          const mailtoLinkElement = document.getElementById("mailto-link");
          if (mailtoLinkElement) {
            mailtoLinkElement.href = mailtoLink;
          }

          // The heading element is already updated above.

          // Redirect
          if (localStorage.getItem("debug-no-redirect") !== "true") {
            window.location.href = mailtoLink;
          }

          setTimeout(function () {
            if (document.visibilityState === "visible") {
              // If the page is still visible after a delay, it's likely no mail handler was found.
              document.querySelector("h1").style.display = "none";
              document.querySelector("p").style.display = "none";
              document.getElementById("no-handler-message").style.display = "block";
            }
          }, 2000);
        } catch (e) {
          document.body.innerHTML = "<h1>" + s.errorHeading + "</h1><p>" + s.errorMessage + "</p>";
          console.error(e);
        }
      });
    </script>
  </body>
</html>
